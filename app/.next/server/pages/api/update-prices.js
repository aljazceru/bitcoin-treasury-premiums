"use strict";(()=>{var e={};e.id=943,e.ids=[943],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},661:e=>{e.exports=require("sqlite3")},7773:e=>{e.exports=require("winston")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},9648:e=>{e.exports=import("axios")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},7598:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{config:()=>E,default:()=>l,routeModule:()=>d});var a=r(1802),s=r(7153),o=r(6249),n=r(3968),c=e([n]);n=(c.then?(await c)():c)[0];let l=(0,o.l)(n,"default"),E=(0,o.l)(n,"config"),d=new a.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/update-prices",pathname:"/api/update-prices",bundlePath:"",filename:""},userland:n});i()}catch(e){i(e)}})},420:(e,t,r)=>{r.d(t,{db:()=>d});var i=r(661),a=r.n(i),s=r(5315),o=r.n(s),n=r(2048),c=r.n(n),l=r(9508);class E{constructor(e){this.isInitialized=!1,this.dbPath=e||process.env.DATABASE_PATH||"./data/treasury.db",this.ensureDataDirectory()}ensureDataDirectory(){let e=o().dirname(this.dbPath);c().existsSync(e)||c().mkdirSync(e,{recursive:!0})}async connect(){return new Promise((e,t)=>{this.db=new(a()).Database(this.dbPath,r=>{r?(l.logger.error("Database connection failed:",r),t(r)):(l.logger.info("Connected to SQLite database"),e())})})}async initialize(){this.isInitialized||(await this.connect(),await this.createTables(),this.isInitialized=!0)}async createTables(){for(let e of[`CREATE TABLE IF NOT EXISTS companies (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        ticker TEXT UNIQUE NOT NULL,
        exchange TEXT,
        country_code TEXT,
        btc_holdings REAL DEFAULT 0,
        shares_outstanding REAL,
        last_holdings_update TEXT,
        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
        updated_at TEXT DEFAULT CURRENT_TIMESTAMP
      )`,`CREATE TABLE IF NOT EXISTS stock_prices (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        ticker TEXT NOT NULL,
        price REAL NOT NULL,
        currency TEXT DEFAULT 'USD',
        timestamp TEXT DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (ticker) REFERENCES companies (ticker)
      )`,`CREATE TABLE IF NOT EXISTS bitcoin_prices (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        price REAL NOT NULL,
        currency TEXT DEFAULT 'USD',
        timestamp TEXT DEFAULT CURRENT_TIMESTAMP
      )`,`CREATE TABLE IF NOT EXISTS schema_version (
        version INTEGER PRIMARY KEY,
        applied_at TEXT DEFAULT CURRENT_TIMESTAMP
      )`,"CREATE INDEX IF NOT EXISTS idx_stock_prices_ticker ON stock_prices(ticker)","CREATE INDEX IF NOT EXISTS idx_stock_prices_timestamp ON stock_prices(timestamp)","CREATE INDEX IF NOT EXISTS idx_bitcoin_prices_timestamp ON bitcoin_prices(timestamp)","CREATE INDEX IF NOT EXISTS idx_companies_ticker ON companies(ticker)","CREATE INDEX IF NOT EXISTS idx_companies_btc_holdings ON companies(btc_holdings)"])await this.run(e);let e=await this.get("SELECT MAX(version) as version FROM schema_version");e&&null!==e.version||(await this.run("INSERT INTO schema_version (version) VALUES (1)"),l.logger.info("Database schema version 1 initialized")),l.logger.info("Database tables created successfully")}async run(e,t=[]){return new Promise((r,i)=>{this.db.run(e,t,e=>{e?(l.logger.error("Database run error:",e),i(e)):r()})})}async get(e,t=[]){return new Promise((r,i)=>{this.db.get(e,t,(e,t)=>{e?(l.logger.error("Database get error:",e),i(e)):r(t)})})}async all(e,t=[]){return new Promise((r,i)=>{this.db.all(e,t,(e,t)=>{e?(l.logger.error("Database all error:",e),i(e)):r(t)})})}async transaction(e){return new Promise((t,r)=>{this.db.serialize(()=>{this.db.run("BEGIN TRANSACTION"),e(this.db).then(e=>{this.db.run("COMMIT",i=>{i?(l.logger.error("Transaction commit error:",i),r(i)):t(e)})}).catch(e=>{this.db.run("ROLLBACK",t=>{t&&l.logger.error("Transaction rollback error:",t),r(e)})})})})}async close(){return new Promise((e,t)=>{this.db.close(r=>{r?(l.logger.error("Database close error:",r),t(r)):(l.logger.info("Database connection closed"),this.isInitialized=!1,e())})})}}let d=new E},3968:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{default:()=>c});var a=r(1925),s=r(5914),o=r(9508),n=e([a,s]);async function c(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});try{await a.m.updatePrice(),s.N.isMarketOpen()&&await s.N.updateAllStockPrices();let e={success:!0,data:{message:"Price update triggered",marketOpen:s.N.isMarketOpen()},timestamp:new Date().toISOString()};t.json(e)}catch(r){o.logger.error("Error updating prices:",r);let e={success:!1,error:"Failed to update prices",timestamp:new Date().toISOString()};t.status(500).json(e)}}[a,s]=n.then?(await n)():n,i()}catch(e){i(e)}})},1925:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.d(t,{m:()=>l});var a=r(9648),s=r(9508),o=r(420),n=e([a]);a=(n.then?(await n)():n)[0];class c{constructor(){this.apiUrl=process.env.COINGECKO_API_URL||"https://api.coingecko.com/api/v3"}async fetchCurrentPrice(){try{let e=await a.default.get(`${this.apiUrl}/simple/price`,{params:{ids:"bitcoin",vs_currencies:"usd"},timeout:1e4}),t=e.data?.bitcoin?.usd;if(!t)throw Error("Invalid response from CoinGecko API");return s.logger.info(`Fetched Bitcoin price: $${t}`),t}catch(t){s.logger.error("Error fetching Bitcoin price:",t);let e=await this.getLastPrice();if(e)return s.logger.warn(`Using last known Bitcoin price: $${e.price}`),e.price;throw t}}async updatePrice(){let e=await this.fetchCurrentPrice();return await o.db.run("INSERT INTO bitcoin_prices (price, currency, timestamp) VALUES (?, ?, datetime('now'))",[e,"USD"]),{price:e,currency:"USD",timestamp:new Date().toISOString()}}async getLastPrice(){return await o.db.get("SELECT * FROM bitcoin_prices ORDER BY timestamp DESC LIMIT 1")}async getPriceHistory(e=24){return await o.db.all(`SELECT * FROM bitcoin_prices 
       WHERE timestamp > datetime('now', '-' || ? || ' hours')
       ORDER BY timestamp DESC`,[e])}}let l=new c;i()}catch(e){i(e)}})},5914:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.d(t,{N:()=>l});var a=r(9648),s=r(9508),o=r(420),n=e([a]);a=(n.then?(await n)():n)[0];class c{constructor(){this.yahooFinanceUrl=process.env.YAHOO_FINANCE_API_URL||"https://query1.finance.yahoo.com/v8/finance"}async fetchStockPrice(e){let t;try{let t=await a.default.get(`${this.yahooFinanceUrl}/chart/${e}`,{headers:{"User-Agent":process.env.USER_AGENT||"Mozilla/5.0 (compatible; BTC-Treasury-Bot/1.0)"},timeout:1e4}),r=t.data?.chart?.result?.[0];if(!r)throw Error(`No data found for ticker ${e}`);let i=r.meta,o=i.regularMarketPrice||i.previousClose,n=i.sharesOutstanding;if(!o)throw Error(`No price data found for ticker ${e}`);return s.logger.info(`Fetched stock price for ${e}: $${o}`),{price:o,sharesOutstanding:n}}catch(r){t=r,s.logger.warn(`Primary API failed for ${e}, trying fallback:`,r)}try{let t=await a.default.get(`https://finance.yahoo.com/quote/${e}`,{headers:{"User-Agent":process.env.USER_AGENT||"Mozilla/5.0 (compatible; BTC-Treasury-Bot/1.0)"},timeout:1e4}),r=t.data.match(/regularMarketPrice":{"raw":(\d+\.?\d*)/),i=t.data.match(/sharesOutstanding":{"raw":(\d+)/);if(r){let t=parseFloat(r[1]),a=i?parseInt(i[1]):void 0;return s.logger.info(`Fetched stock price for ${e} via fallback: $${t}`),{price:t,sharesOutstanding:a}}}catch(t){s.logger.error(`Fallback API also failed for ${e}:`,t)}try{let t=await this.getLastPrice(e);if(t)return s.logger.warn(`Using last known price for ${e}: $${t.price}`),{price:t.price}}catch(t){s.logger.error(`Failed to get last known price for ${e}:`,t)}throw s.logger.error(`All attempts failed for ${e}`),Error(`Failed to fetch stock price for ${e}: ${t.message}`)}async updateStockPrice(e){let{price:t,sharesOutstanding:r}=await this.fetchStockPrice(e);return await o.db.run("INSERT INTO stock_prices (ticker, price, currency, timestamp) VALUES (?, ?, ?, datetime('now'))",[e,t,"USD"]),r&&await o.db.run("UPDATE companies SET shares_outstanding = ?, updated_at = datetime('now') WHERE ticker = ?",[r/1e6,e]),s.logger.info(`Updated stock price for ${e}: $${t}`),{ticker:e,price:t,currency:"USD",timestamp:new Date().toISOString()}}async updateAllStockPrices(){for(let e of(await o.db.all("SELECT ticker FROM companies")))try{await this.updateStockPrice(e.ticker),await new Promise(e=>setTimeout(e,1e3))}catch(t){s.logger.error(`Failed to update price for ${e.ticker}:`,t)}}async getLastPrice(e){return await o.db.get("SELECT * FROM stock_prices WHERE ticker = ? ORDER BY timestamp DESC LIMIT 1",[e])}async getPriceHistory(e,t=24){return await o.db.all(`SELECT * FROM stock_prices 
       WHERE ticker = ? AND timestamp > datetime('now', '-' || ? || ' hours')
       ORDER BY timestamp DESC`,[e,t])}isMarketOpen(){let e=new Date,t=new Date(e.toLocaleString("en-US",{timeZone:"America/New_York"})),r=t.getDay(),i=t.getHours(),a=t.getMinutes();return r>=1&&r<=5&&(9===i&&a>=30||i>9&&i<16)}}let l=new c;i()}catch(e){i(e)}})},9508:(e,t,r)=>{r.d(t,{logger:()=>d});var i=r(7773),a=r.n(i),s=r(5315),o=r.n(s),n=r(2048),c=r.n(n);let l=o().join(process.cwd(),"logs");c().existsSync(l)||c().mkdirSync(l,{recursive:!0});let E=a().format.printf(({timestamp:e,level:t,message:r,...i})=>{let a=`${e} [${t}]: ${r}`;if(Object.keys(i).length>0)try{a+=` ${JSON.stringify(i,null,0)}`}catch(e){a+=" [Object with circular reference]"}return a}),d=a().createLogger({level:process.env.LOG_LEVEL||"info",format:a().format.combine(a().format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),a().format.errors({stack:!0}),a().format.splat(),E),transports:[new(a()).transports.Console({format:a().format.combine(a().format.colorize(),E)}),new(a()).transports.File({filename:o().join(l,"error.log"),level:"error"}),new(a()).transports.File({filename:o().join(l,"combined.log")})]})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=7598);module.exports=r})();