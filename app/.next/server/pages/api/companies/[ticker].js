"use strict";(()=>{var e={};e.id=83,e.ids=[83],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},661:e=>{e.exports=require("sqlite3")},7773:e=>{e.exports=require("winston")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},9648:e=>{e.exports=import("axios")},9042:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>p,default:()=>l,routeModule:()=>u});var i=r(1802),o=r(7153),c=r(6249),s=r(8887),n=e([s]);s=(n.then?(await n)():n)[0];let l=(0,c.l)(s,"default"),p=(0,c.l)(s,"config"),u=new i.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/companies/[ticker]",pathname:"/api/companies/[ticker]",bundlePath:"",filename:""},userland:s});a()}catch(e){a(e)}})},8887:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>l});var i=r(5232),o=r(1925),c=r(5914),s=r(9508),n=e([o,c]);async function l(e,t){if("GET"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let{ticker:r}=e.query;if(!r||"string"!=typeof r||0===r.trim().length){let e={success:!1,error:"Invalid ticker symbol",timestamp:new Date().toISOString()};t.status(400).json(e);return}let a=r.trim().toUpperCase();if(a.length>10){let e={success:!1,error:"Ticker symbol too long",timestamp:new Date().toISOString()};t.status(400).json(e);return}let s=await i.l.getCompanyByTicker(a);if(!s){let e={success:!1,error:"Company not found",timestamp:new Date().toISOString()};t.status(404).json(e);return}let n=await c.N.getLastPrice(a),l=await o.m.getLastPrice(),p={success:!0,data:{...s,stock_price:n?.price,bitcoin_price:l?.price},timestamp:new Date().toISOString()};t.json(p)}catch(r){s.logger.error("Error getting company:",r);let e={success:!1,error:"Failed to fetch company",timestamp:new Date().toISOString()};t.status(500).json(e)}}[o,c]=n.then?(await n)():n,a()}catch(e){a(e)}})},1925:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{m:()=>l});var i=r(9648),o=r(9508),c=r(420),s=e([i]);i=(s.then?(await s)():s)[0];class n{constructor(){this.apiUrl=process.env.COINGECKO_API_URL||"https://api.coingecko.com/api/v3"}async fetchCurrentPrice(){try{let e=await i.default.get(`${this.apiUrl}/simple/price`,{params:{ids:"bitcoin",vs_currencies:"usd"},timeout:1e4}),t=e.data?.bitcoin?.usd;if(!t)throw Error("Invalid response from CoinGecko API");return o.logger.info(`Fetched Bitcoin price: $${t}`),t}catch(t){o.logger.error("Error fetching Bitcoin price:",t);let e=await this.getLastPrice();if(e)return o.logger.warn(`Using last known Bitcoin price: $${e.price}`),e.price;throw t}}async updatePrice(){let e=await this.fetchCurrentPrice();return await c.db.run("INSERT INTO bitcoin_prices (price, currency, timestamp) VALUES (?, ?, datetime('now'))",[e,"USD"]),{price:e,currency:"USD",timestamp:new Date().toISOString()}}async getLastPrice(){return await c.db.get("SELECT * FROM bitcoin_prices ORDER BY timestamp DESC LIMIT 1")}async getPriceHistory(e=24){return await c.db.all(`SELECT * FROM bitcoin_prices 
       WHERE timestamp > datetime('now', '-' || ? || ' hours')
       ORDER BY timestamp DESC`,[e])}}let l=new n;a()}catch(e){a(e)}})},5914:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{N:()=>l});var i=r(9648),o=r(9508),c=r(420),s=e([i]);i=(s.then?(await s)():s)[0];class n{constructor(){this.yahooFinanceUrl=process.env.YAHOO_FINANCE_API_URL||"https://query1.finance.yahoo.com/v8/finance"}async fetchStockPrice(e){let t;try{let t=await i.default.get(`${this.yahooFinanceUrl}/chart/${e}`,{headers:{"User-Agent":process.env.USER_AGENT||"Mozilla/5.0 (compatible; BTC-Treasury-Bot/1.0)"},timeout:1e4}),r=t.data?.chart?.result?.[0];if(!r)throw Error(`No data found for ticker ${e}`);let a=r.meta,c=a.regularMarketPrice||a.previousClose,s=a.sharesOutstanding;if(!c)throw Error(`No price data found for ticker ${e}`);return o.logger.info(`Fetched stock price for ${e}: $${c}`),{price:c,sharesOutstanding:s}}catch(r){t=r,o.logger.warn(`Primary API failed for ${e}, trying fallback:`,r)}try{let t=await i.default.get(`https://finance.yahoo.com/quote/${e}`,{headers:{"User-Agent":process.env.USER_AGENT||"Mozilla/5.0 (compatible; BTC-Treasury-Bot/1.0)"},timeout:1e4}),r=t.data.match(/regularMarketPrice":{"raw":(\d+\.?\d*)/),a=t.data.match(/sharesOutstanding":{"raw":(\d+)/);if(r){let t=parseFloat(r[1]),i=a?parseInt(a[1]):void 0;return o.logger.info(`Fetched stock price for ${e} via fallback: $${t}`),{price:t,sharesOutstanding:i}}}catch(t){o.logger.error(`Fallback API also failed for ${e}:`,t)}try{let t=await this.getLastPrice(e);if(t)return o.logger.warn(`Using last known price for ${e}: $${t.price}`),{price:t.price}}catch(t){o.logger.error(`Failed to get last known price for ${e}:`,t)}throw o.logger.error(`All attempts failed for ${e}`),Error(`Failed to fetch stock price for ${e}: ${t.message}`)}async updateStockPrice(e){let{price:t,sharesOutstanding:r}=await this.fetchStockPrice(e);return await c.db.run("INSERT INTO stock_prices (ticker, price, currency, timestamp) VALUES (?, ?, ?, datetime('now'))",[e,t,"USD"]),r&&await c.db.run("UPDATE companies SET shares_outstanding = ?, updated_at = datetime('now') WHERE ticker = ?",[r/1e6,e]),o.logger.info(`Updated stock price for ${e}: $${t}`),{ticker:e,price:t,currency:"USD",timestamp:new Date().toISOString()}}async updateAllStockPrices(){for(let e of(await c.db.all("SELECT ticker FROM companies")))try{await this.updateStockPrice(e.ticker),await new Promise(e=>setTimeout(e,1e3))}catch(t){o.logger.error(`Failed to update price for ${e.ticker}:`,t)}}async getLastPrice(e){return await c.db.get("SELECT * FROM stock_prices WHERE ticker = ? ORDER BY timestamp DESC LIMIT 1",[e])}async getPriceHistory(e,t=24){return await c.db.all(`SELECT * FROM stock_prices 
       WHERE ticker = ? AND timestamp > datetime('now', '-' || ? || ' hours')
       ORDER BY timestamp DESC`,[e,t])}isMarketOpen(){let e=new Date,t=new Date(e.toLocaleString("en-US",{timeZone:"America/New_York"})),r=t.getDay(),a=t.getHours(),i=t.getMinutes();return r>=1&&r<=5&&(9===a&&i>=30||a>9&&a<16)}}let l=new n;a()}catch(e){a(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[479],()=>r(9042));module.exports=a})();