"use strict";(()=>{var e={};e.id=835,e.ids=[835],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},661:e=>{e.exports=require("sqlite3")},7773:e=>{e.exports=require("winston")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},9648:e=>{e.exports=import("axios")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},352:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>E,default:()=>l,routeModule:()=>T});var i=r(1802),s=r(7153),o=r(6249),n=r(2756),c=e([n]);n=(c.then?(await c)():c)[0];let l=(0,o.l)(n,"default"),E=(0,o.l)(n,"config"),T=new i.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/market-status",pathname:"/api/market-status",bundlePath:"",filename:""},userland:n});a()}catch(e){a(e)}})},420:(e,t,r)=>{r.d(t,{db:()=>T});var a=r(661),i=r.n(a),s=r(5315),o=r.n(s),n=r(2048),c=r.n(n),l=r(9508);class E{constructor(e){this.isInitialized=!1,this.dbPath=e||process.env.DATABASE_PATH||"./data/treasury.db",this.ensureDataDirectory()}ensureDataDirectory(){let e=o().dirname(this.dbPath);c().existsSync(e)||c().mkdirSync(e,{recursive:!0})}async connect(){return new Promise((e,t)=>{this.db=new(i()).Database(this.dbPath,r=>{r?(l.logger.error("Database connection failed:",r),t(r)):(l.logger.info("Connected to SQLite database"),e())})})}async initialize(){this.isInitialized||(await this.connect(),await this.createTables(),this.isInitialized=!0)}async createTables(){for(let e of[`CREATE TABLE IF NOT EXISTS companies (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        ticker TEXT UNIQUE NOT NULL,
        exchange TEXT,
        country_code TEXT,
        btc_holdings REAL DEFAULT 0,
        shares_outstanding REAL,
        last_holdings_update TEXT,
        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
        updated_at TEXT DEFAULT CURRENT_TIMESTAMP
      )`,`CREATE TABLE IF NOT EXISTS stock_prices (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        ticker TEXT NOT NULL,
        price REAL NOT NULL,
        currency TEXT DEFAULT 'USD',
        timestamp TEXT DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (ticker) REFERENCES companies (ticker)
      )`,`CREATE TABLE IF NOT EXISTS bitcoin_prices (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        price REAL NOT NULL,
        currency TEXT DEFAULT 'USD',
        timestamp TEXT DEFAULT CURRENT_TIMESTAMP
      )`,`CREATE TABLE IF NOT EXISTS schema_version (
        version INTEGER PRIMARY KEY,
        applied_at TEXT DEFAULT CURRENT_TIMESTAMP
      )`,"CREATE INDEX IF NOT EXISTS idx_stock_prices_ticker ON stock_prices(ticker)","CREATE INDEX IF NOT EXISTS idx_stock_prices_timestamp ON stock_prices(timestamp)","CREATE INDEX IF NOT EXISTS idx_bitcoin_prices_timestamp ON bitcoin_prices(timestamp)","CREATE INDEX IF NOT EXISTS idx_companies_ticker ON companies(ticker)","CREATE INDEX IF NOT EXISTS idx_companies_btc_holdings ON companies(btc_holdings)"])await this.run(e);let e=await this.get("SELECT MAX(version) as version FROM schema_version");e&&null!==e.version||(await this.run("INSERT INTO schema_version (version) VALUES (1)"),l.logger.info("Database schema version 1 initialized")),l.logger.info("Database tables created successfully")}async run(e,t=[]){return new Promise((r,a)=>{this.db.run(e,t,e=>{e?(l.logger.error("Database run error:",e),a(e)):r()})})}async get(e,t=[]){return new Promise((r,a)=>{this.db.get(e,t,(e,t)=>{e?(l.logger.error("Database get error:",e),a(e)):r(t)})})}async all(e,t=[]){return new Promise((r,a)=>{this.db.all(e,t,(e,t)=>{e?(l.logger.error("Database all error:",e),a(e)):r(t)})})}async transaction(e){return new Promise((t,r)=>{this.db.serialize(()=>{this.db.run("BEGIN TRANSACTION"),e(this.db).then(e=>{this.db.run("COMMIT",a=>{a?(l.logger.error("Transaction commit error:",a),r(a)):t(e)})}).catch(e=>{this.db.run("ROLLBACK",t=>{t&&l.logger.error("Transaction rollback error:",t),r(e)})})})})}async close(){return new Promise((e,t)=>{this.db.close(r=>{r?(l.logger.error("Database close error:",r),t(r)):(l.logger.info("Database connection closed"),this.isInitialized=!1,e())})})}}let T=new E},2756:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>o});var i=r(5914),s=e([i]);async function o(e,t){if("GET"!==e.method)return t.status(405).json({message:"Method not allowed"});let r=i.N.isMarketOpen(),a={success:!0,data:{marketOpen:r,message:r?"US stock market is open":"US stock market is closed"},timestamp:new Date().toISOString()};t.json(a)}i=(s.then?(await s)():s)[0],a()}catch(e){a(e)}})},5914:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{N:()=>l});var i=r(9648),s=r(9508),o=r(420),n=e([i]);i=(n.then?(await n)():n)[0];class c{constructor(){this.yahooFinanceUrl=process.env.YAHOO_FINANCE_API_URL||"https://query1.finance.yahoo.com/v8/finance"}async fetchStockPrice(e){let t;try{let t=await i.default.get(`${this.yahooFinanceUrl}/chart/${e}`,{headers:{"User-Agent":process.env.USER_AGENT||"Mozilla/5.0 (compatible; BTC-Treasury-Bot/1.0)"},timeout:1e4}),r=t.data?.chart?.result?.[0];if(!r)throw Error(`No data found for ticker ${e}`);let a=r.meta,o=a.regularMarketPrice||a.previousClose,n=a.sharesOutstanding;if(!o)throw Error(`No price data found for ticker ${e}`);return s.logger.info(`Fetched stock price for ${e}: $${o}`),{price:o,sharesOutstanding:n}}catch(r){t=r,s.logger.warn(`Primary API failed for ${e}, trying fallback:`,r)}try{let t=await i.default.get(`https://finance.yahoo.com/quote/${e}`,{headers:{"User-Agent":process.env.USER_AGENT||"Mozilla/5.0 (compatible; BTC-Treasury-Bot/1.0)"},timeout:1e4}),r=t.data.match(/regularMarketPrice":{"raw":(\d+\.?\d*)/),a=t.data.match(/sharesOutstanding":{"raw":(\d+)/);if(r){let t=parseFloat(r[1]),i=a?parseInt(a[1]):void 0;return s.logger.info(`Fetched stock price for ${e} via fallback: $${t}`),{price:t,sharesOutstanding:i}}}catch(t){s.logger.error(`Fallback API also failed for ${e}:`,t)}try{let t=await this.getLastPrice(e);if(t)return s.logger.warn(`Using last known price for ${e}: $${t.price}`),{price:t.price}}catch(t){s.logger.error(`Failed to get last known price for ${e}:`,t)}throw s.logger.error(`All attempts failed for ${e}`),Error(`Failed to fetch stock price for ${e}: ${t.message}`)}async updateStockPrice(e){let{price:t,sharesOutstanding:r}=await this.fetchStockPrice(e);return await o.db.run("INSERT INTO stock_prices (ticker, price, currency, timestamp) VALUES (?, ?, ?, datetime('now'))",[e,t,"USD"]),r&&await o.db.run("UPDATE companies SET shares_outstanding = ?, updated_at = datetime('now') WHERE ticker = ?",[r/1e6,e]),s.logger.info(`Updated stock price for ${e}: $${t}`),{ticker:e,price:t,currency:"USD",timestamp:new Date().toISOString()}}async updateAllStockPrices(){for(let e of(await o.db.all("SELECT ticker FROM companies")))try{await this.updateStockPrice(e.ticker),await new Promise(e=>setTimeout(e,1e3))}catch(t){s.logger.error(`Failed to update price for ${e.ticker}:`,t)}}async getLastPrice(e){return await o.db.get("SELECT * FROM stock_prices WHERE ticker = ? ORDER BY timestamp DESC LIMIT 1",[e])}async getPriceHistory(e,t=24){return await o.db.all(`SELECT * FROM stock_prices 
       WHERE ticker = ? AND timestamp > datetime('now', '-' || ? || ' hours')
       ORDER BY timestamp DESC`,[e,t])}isMarketOpen(){let e=new Date,t=new Date(e.toLocaleString("en-US",{timeZone:"America/New_York"})),r=t.getDay(),a=t.getHours(),i=t.getMinutes();return r>=1&&r<=5&&(9===a&&i>=30||a>9&&a<16)}}let l=new c;a()}catch(e){a(e)}})},9508:(e,t,r)=>{r.d(t,{logger:()=>T});var a=r(7773),i=r.n(a),s=r(5315),o=r.n(s),n=r(2048),c=r.n(n);let l=o().join(process.cwd(),"logs");c().existsSync(l)||c().mkdirSync(l,{recursive:!0});let E=i().format.printf(({timestamp:e,level:t,message:r,...a})=>{let i=`${e} [${t}]: ${r}`;if(Object.keys(a).length>0)try{i+=` ${JSON.stringify(a,null,0)}`}catch(e){i+=" [Object with circular reference]"}return i}),T=i().createLogger({level:process.env.LOG_LEVEL||"info",format:i().format.combine(i().format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),i().format.errors({stack:!0}),i().format.splat(),E),transports:[new(i()).transports.Console({format:i().format.combine(i().format.colorize(),E)}),new(i()).transports.File({filename:o().join(l,"error.log"),level:"error"}),new(i()).transports.File({filename:o().join(l,"combined.log")})]})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=352);module.exports=r})();